<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Celebrity Feed</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* Custom scrollbar for stories */
.stories-container::-webkit-scrollbar { height: 4px; }
.stories-container::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 2px; }
/* Container styling */
#app-container { max-width: 1400px; margin: 0 auto; padding: 1rem; }
/* Sticky sidebar */
.sticky-sidebar { top: 6rem; }
/* Comments scrollbar */
.comment-list-container::-webkit-scrollbar { width: 4px; }
.comment-list-container::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 2px; }
/* Dropdown transition */
.dropdownMenu.max-h-0 { transition: max-height 0.2s ease-out, opacity 0.2s ease-out, transform 0.2s ease-out; }
</style>
<script>
tailwind.config = {
    theme: {
        extend: {
            colors: {
                'primary': '#9333ea',
                'primary-dark': '#7e22ce',
                'soft-gray': '#f9fafb',
            },
        },
    },
};
</script>
</head>
<body class="bg-gray-50 font-sans">
{% include 'header_nav.html' %}
<div id="app-container" class="mt-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
    <div class="lg:col-span-3 space-y-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 lg:block hidden">Welcome, {{ username }}!</h2>
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <h3 class="text-lg font-semibold mb-4 text-gray-800">My Friends</h3>
            <div class="flex space-x-5 overflow-x-auto stories-container pb-2">
                <div class="flex flex-col items-center flex-shrink-0 w-20 cursor-pointer">
                    <div class="relative w-16 h-16 rounded-full bg-gray-200 flex items-center justify-center border-2 border-dashed border-gray-400 text-lg font-bold text-gray-700 hover:border-primary transition duration-300">
                        {% if username %}{{ username[0] }}{% else %}U{% endif %}
                    </div>
                    <span class="text-xs mt-1 text-gray-500">My Story</span>
                </div>
                {% for friend in friends %}
                <div class="flex flex-col items-center flex-shrink-0 w-20 cursor-pointer">
                    <a href="/friend/{{ friend.username }}" class="relative w-16 h-16 rounded-full bg-gray-200 ring-2 ring-primary ring-offset-2 ring-offset-white flex items-center justify-center text-lg font-bold text-primary hover:ring-primary-dark transition duration-300">
                        {{ friend.username[0] }}
                    </a>
                    <span class="text-xs mt-1 text-gray-700 truncate w-16 text-center">{{ friend.username }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
            <h3 class="text-lg font-semibold mb-4 text-gray-800">Share Your Insight</h3>
            <form id="post-form" method="post" action="/post">
                <div class="mb-4">
                    <textarea class="w-full p-3 border border-gray-200 bg-gray-50 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary resize-none text-gray-700" name="post" rows="3" placeholder="What's the latest gossip?"></textarea>
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="px-5 py-2 bg-primary text-white text-sm font-semibold rounded-full hover:bg-primary-dark shadow-md transition" name="post-submit">Post</button>
                </div>
            </form>
        </div>
        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
            <h5 class="font-bold text-lg mb-3 text-gray-800">Find & Follow</h5>
            <form method="post" action="/addfriend" class="flex flex-col space-y-3">
                <input type="text" class="px-3 py-2 border border-gray-200 bg-gray-50 rounded-lg focus:ring-primary focus:border-primary text-sm text-gray-700" name="name" placeholder="Username to follow" />
                <button type="submit" class="w-full py-2 bg-primary/10 text-primary text-sm font-semibold rounded-lg hover:bg-primary/20 transition" name="addfriend">Follow</button>
            </form>
        </div>
    </div>

    <div class="lg:col-span-6 space-y-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 lg:hidden">Celebrity News</h2>
        <div id="main-feed-grid" class="space-y-6">
            {% for post in posts %}
            <div class="border border-gray-100 rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 bg-white" id="post-{{ post.doc_id }}">
                <div class="p-5">
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <div class="w-9 h-9 rounded-full bg-gray-200 mr-3 flex items-center justify-center text-sm font-semibold text-gray-700">
                                {{ post.user[0] }}
                            </div>
                            <div>
                                <h6 class="font-bold text-base text-gray-900">{{ post.user }}</h6>
                                <small class="text-xs text-gray-500">{{ post.time|convert_time }}</small>
                            </div>
                        </div>
                        <button class="text-gray-400 hover:text-primary p-2 rounded-full hover:bg-gray-50 transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path></svg>
                        </button>
                    </div>
                    <p class="text-base text-gray-800 line-clamp-3 mb-4">{{ post.text }}</p>
                    <div class="flex justify-around items-center pt-3 border-t border-gray-100 text-gray-500">
                        <button class="flex items-center space-x-1 hover:text-red-500 transition p-2 rounded-lg like-button" data-likes="{{ post.like_count or 0 }}" data-post-id="{{ post.doc_id }}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                            <span class="text-sm post-like-count">{{ post.like_count or 0 }}</span>
                        </button>
                        <button class="flex items-center space-x-1 hover:text-primary transition p-2 rounded-lg comment-toggle" data-post-id="{{ post.doc_id }}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                            <span class="text-sm post-comment-count">{{ post.comments|count }}</span>
                        </button>
                    </div>
                </div>

                <!-- Comment Section -->
                <div class="px-5 pb-5 pt-3 border-t border-gray-100 hidden comment-section" id="comments-for-post-{{ post.doc_id }}">
                    <div class="space-y-3 mb-4 max-h-48 overflow-y-auto pr-2 comment-list-container" id="comment-list-{{ post.doc_id }}">
                        {% for comment in post.comments %}
                        <div class="flex space-x-2 text-sm">
                            <div class="w-6 h-6 rounded-full bg-gray-100 flex items-center justify-center text-xs font-semibold text-gray-600 flex-shrink-0">{{ comment.user[0] }}</div>
                            <p class="text-gray-700">
                                <span class="font-semibold">{{ comment.user }}</span> {{ comment.text }}
                                <span class="text-xs text-gray-400 block mt-0.5">{{ comment.time }}</span>
                            </p>
                        </div>
                        {% endfor %}
                        {% if not post.comments %}
                        <p class="text-gray-400 text-sm italic text-center py-2 no-comments-message">No comments yet. Be the first to reply!</p>
                        {% endif %}
                    </div>
                    <form class="comment-form flex space-x-2" data-post-id="{{ post.doc_id }}">
                        <input type="text" name="comment_text" placeholder="Add a comment..." class="flex-grow p-2 border border-gray-200 bg-gray-50 rounded-lg text-sm focus:ring-primary focus:border-primary" required>
                        <button type="submit" class="px-3 py-1 bg-primary text-white text-xs font-semibold rounded-lg hover:bg-primary-dark transition">Post</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Right Sidebar -->
    <div class="lg:col-span-3 space-y-6">
        <!-- Your Trending content remains unchanged -->
    </div>
</div>

<script>
// Like button logic
const initializeLikeButton = (button) => {
    button.addEventListener('click', function() {
        let currentLikes = parseInt(button.getAttribute('data-likes')) || 0;
        const countSpan = button.querySelector('.post-like-count');
        if (button.classList.contains('liked')) {
            currentLikes--;
            button.classList.remove('liked', 'text-red-500');
            button.classList.add('text-gray-500');
        } else {
            currentLikes++;
            button.classList.add('liked', 'text-red-500');
            button.classList.remove('text-gray-500');
        }
        button.setAttribute('data-likes', currentLikes);
        countSpan.textContent = currentLikes;
    });
};

// Comment toggle logic
const initializeCommentToggle = (button) => {
    button.addEventListener('click', function() {
        const postId = button.getAttribute('data-post-id');
        const commentSection = document.getElementById(`comments-for-post-${postId}`);
        if (commentSection) commentSection.classList.toggle('hidden');
    });
};

// Comment form logic (AJAX)
const initializeCommentForm = (form) => {
    form.addEventListener('submit', function(event) {
        event.preventDefault();
        const postId = form.getAttribute('data-post-id');
        const commentInput = form.querySelector('input[name="comment_text"]');
        const text = commentInput.value.trim();
        if (!text) return alert('Your comment cannot be empty!');

        const formData = new FormData();
        formData.append('comment_text', text);

        fetch(`/comment/${postId}`, { method: 'POST', body: formData })
            .then(res => { if(!res.ok) throw new Error(`Server error (${res.status})`); return res.json(); })
            .then(data => {
                commentInput.value = '';
                const commentList = document.getElementById(`comment-list-${postId}`);
                const countSpan = document.querySelector(`#post-${postId} .post-comment-count`);
                const noCommentsMsg = commentList.querySelector('.no-comments-message');
                if (noCommentsMsg) noCommentsMsg.remove();
                commentList.insertAdjacentHTML('afterbegin', `
                    <div class="flex space-x-2 text-sm">
                        <div class="w-6 h-6 rounded-full bg-primary/10 flex items-center justify-center text-xs font-semibold text-primary flex-shrink-0">${data.user[0]}</div>
                        <p class="text-gray-700">
                            <span class="font-semibold">${data.user}</span> ${data.text}
                            <span class="text-xs text-gray-400 block mt-0.5">${data.time}</span>
                        </p>
                    </div>
                `);
                countSpan.textContent = (parseInt(countSpan.textContent) || 0) + 1;
            })
            .catch(err => { console.error(err); alert('Error posting comment: ' + err.message); });
    });
};

// Initialize everything on DOM load
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.like-button').forEach(initializeLikeButton);
    document.querySelectorAll('.comment-toggle').forEach(initializeCommentToggle);
    document.querySelectorAll('.comment-form').forEach(initializeCommentForm);
});
</script>
</body>
</html>
